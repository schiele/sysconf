#!/bin/bash
dotfile="$1"
shift
logfile=$(mktemp)
strace -f -o "$logfile" -s 64000 -v -e trace=process "$@"
set -eu
exec 3> "$dotfile"
echo >&3 'digraph cip {'
echo >&3 'overlap=false'
for node in $(sed -e 's, .*$,,' "$logfile" | sort -u); do
    rv=$(sed -ne 's,^'"$node"' *+++ exited with \([0-9]*\) +++$,\1,p' "$logfile")
    case "$rv" in
        '') color=grey;;
        0) color=green;;
        *) color=red;;
    esac
    echo >&3 '"'"$node"'" [label="'"$node"'\n'"$(
            sed -ne 's,^'"$node"' *execve("[^"]*/\([^"/]*\)".*$,\1,p' "$logfile" |
            tr '\n' / | sed -e 's,/$,,;s,/,\\n,g'
        )"'\n'"$rv"'", style=filled, color='"$color"']'
done
sed >&3 -ne '
    s/^\([0-9]*\) *\(\(clone\)\|\(fork\)\|\(vfork\)\)(.*) *= \([0-9]*\)$/"\1"->"\6"/p
    s/^\([0-9]*\) *<\.\.\. \(\(clone\)\|\(fork\)\|\(vfork\)\) resumed>.*) *= \([0-9]*\)$/"\1"->"\6"/p
    ' "$logfile"
echo >&3 '}'
rm "$logfile"
