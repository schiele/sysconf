#!/bin/bash
dotfile="$1"
shift
logfile=$(mktemp)
strace -f -o "$logfile" -s 64000 -v -e trace=process "$@"
set -eu
echo > "$dotfile" 'digraph cip {'
echo >> "$dotfile" 'overlap=false'
for node in $(sed -e 's, .*$,,' "$logfile" | sort -u); do
    rv=$(sed -ne 's,^'"$node"' *+++ exited with \([0-9]*\) +++$,\1,p' "$logfile")
    case "$rv" in
        '') color=grey;;
        0) color=green;;
        *) color=red;;
    esac
    echo >> "$dotfile" '"'"$node"'" [label="'"$node"'\n'"$(
            sed -ne 's,^'"$node"' *execve("[^"]*/\([^"/]*\)".*$,\1,p' "$logfile" |
            tr '\n' / | sed -e 's,/$,,;s,/,\\n,g'
        )"'\n'"$rv"'", style=filled, color='"$color"']'
done
sed >> "$dotfile" -ne '
    s/^\([0-9]*\) *\(\(clone\)\|\(fork\)\|\(vfork\)\)(.*) *= \([0-9]*\)$/"\1"->"\6"/p
    s/^\([0-9]*\) *<\.\.\. \(\(clone\)\|\(fork\)\|\(vfork\)\) resumed>.*) *= \([0-9]*\)$/"\1"->"\6"/p
    ' "$logfile"
echo >> "$dotfile" '}'
rm "$logfile"
